<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Upload Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .form-container {
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }
        #loadingSpinner {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="form-container">
            <h2 class="mb-4 text-center">Add New Project</h2>
            
            <form id="projectForm">
                <div class="mb-3">
                    <label for="title" class="form-label">Project Title*</label>
                    <input type="text" class="form-control" id="title" required minlength="3">
                    <div class="invalid-feedback">Please provide at least 3 characters</div>
                </div>
                
                <div class="mb-3">
                    <label for="description" class="form-label">Description*</label>
                    <textarea class="form-control" id="description" rows="3" required minlength="10"></textarea>
                    <div class="invalid-feedback">Please provide at least 10 characters</div>
                </div>
                
                <div class="mb-3">
                    <label for="image_url" class="form-label">Image URL</label>
                    <input type="url" class="form-control" id="image_url" placeholder="https://example.com/image.jpg">
                    <div class="invalid-feedback">Please enter a valid URL</div>
                </div>
                
                <div class="mb-3">
                    <label for="project_url" class="form-label">Project URL</label>
                    <input type="url" class="form-control" id="project_url" placeholder="https://example.com">
                    <div class="invalid-feedback">Please enter a valid URL</div>
                </div>
                
                <div class="mb-3">
                    <label for="category" class="form-label">Category</label>
                    <select class="form-select" id="category" required>
                        <option value="" disabled selected>Select a category</option>
                        <option value="web">Web Development</option>
                        <option value="mobile">Mobile App</option>
                        <option value="design">Design</option>
                        <option value="other">Other</option>
                    </select>
                    <div class="invalid-feedback">Please select a category</div>
                </div>
                
                <div class="mb-3 form-check">
                    <input type="checkbox" class="form-check-input" id="is_featured">
                    <label class="form-check-label" for="is_featured">Featured Project</label>
                </div>
                
                <button type="submit" class="btn btn-primary w-100" id="submitBtn">
                    <span id="submitText">Add Project</span>
                    <span id="loadingSpinner" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                </button>
            </form>
            
            <div id="responseMessage" class="mt-3 alert" style="display: none;"></div>
            
            <!-- Project List Preview -->
            <div class="mt-5" id="projectsPreview" style="display: none;">
                <h4 class="mb-3">Current Projects</h4>
                <div id="projectsList" class="list-group"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuration - In production, use environment variables
        const API_CONFIG = {
            BASE_URL: 'https://odondimeshack.wuaze.com/api.php',
            SECRET_KEY: 'My5ite@2024_Od0nd!Pr0j3ct$3cr3tK3y'
        };

        // DOM Elements
        const form = document.getElementById('projectForm');
        const submitBtn = document.getElementById('submitBtn');
        const submitText = document.getElementById('submitText');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const responseDiv = document.getElementById('responseMessage');
        const projectsPreview = document.getElementById('projectsPreview');
        const projectsList = document.getElementById('projectsList');

        // Form validation
        function validateForm() {
            let isValid = true;
            const requiredFields = form.querySelectorAll('[required]');
            
            requiredFields.forEach(field => {
                field.classList.remove('is-invalid');
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else if (field.hasAttribute('minlength') && 
                          field.value.length < parseInt(field.getAttribute('minlength'))) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else if (field.type === 'url' && field.value && 
                          !field.value.match(/^https?:\/\/.+\..+/)) {
                    field.classList.add('is-invalid');
                    isValid = false;
                }
            });
            
            return isValid;
        }

        // Load existing projects
        async function loadProjects() {
            try {
                const response = await fetch(`${API_CONFIG.BASE_URL}?key=${API_CONFIG.SECRET_KEY}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('Error loading projects:', error);
                return [];
            }
        }

        // Display projects
        async function displayProjects() {
            const projects = await loadProjects();
            
            if (projects.length > 0) {
                projectsPreview.style.display = 'block';
                projectsList.innerHTML = '';
                
                projects.forEach(project => {
                    const projectItem = document.createElement('div');
                    projectItem.className = 'list-group-item';
                    projectItem.innerHTML = `
                        <div class="d-flex w-100 justify-content-between">
                            <h5 class="mb-1">${project.title}</h5>
                            <small>${new Date(project.date_created).toLocaleDateString()}</small>
                        </div>
                        <p class="mb-1">${project.description.substring(0, 100)}...</p>
                        <small>Category: ${project.category}</small>
                    `;
                    projectsList.appendChild(projectItem);
                });
            }
        }

        // Form submission
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!validateForm()) return;
            
            // Prepare form data
            const formData = {
                title: document.getElementById('title').value.trim(),
                description: document.getElementById('description').value.trim(),
                image_url: document.getElementById('image_url').value.trim() || null,
                project_url: document.getElementById('project_url').value.trim() || null,
                category: document.getElementById('category').value,
                is_featured: document.getElementById('is_featured').checked
            };
            
            // UI State
            submitBtn.disabled = true;
            submitText.textContent = 'Processing...';
            loadingSpinner.style.display = 'inline-block';
            responseDiv.style.display = 'none';
            
            try {
                const response = await fetch(`${API_CONFIG.BASE_URL}?key=${API_CONFIG.SECRET_KEY}&action=add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    responseDiv.className = 'mt-3 alert alert-success';
                    responseDiv.innerHTML = `
                        <strong>Success!</strong> Project added successfully.
                        ${result.id ? `<br><small>Project ID: ${result.id}</small>` : ''}
                    `;
                    form.reset();
                    displayProjects(); // Refresh project list
                } else {
                    throw new Error(result.error || 'Failed to add project');
                }
            } catch (error) {
                console.error('Submission error:', error);
                responseDiv.className = 'mt-3 alert alert-danger';
                responseDiv.innerHTML = `
                    <strong>Error!</strong> ${error.message}
                    <br><small>Check console for details</small>
                `;
            } finally {
                responseDiv.style.display = 'block';
                submitBtn.disabled = false;
                submitText.textContent = 'Add Project';
                loadingSpinner.style.display = 'none';
                
                // Scroll to response message
                responseDiv.scrollIntoView({ behavior: 'smooth' });
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            displayProjects();
            
            // Add input validation on blur
            const inputs = form.querySelectorAll('input, textarea, select');
            inputs.forEach(input => {
                input.addEventListener('blur', () => {
                    if (input.hasAttribute('required')) {
                        validateField(input);
                    }
                });
            });
        });

        function validateField(field) {
            field.classList.remove('is-invalid');
            if (field.hasAttribute('required') && !field.value.trim()) {
                field.classList.add('is-invalid');
            }
        }
    </script>
</body>
</html>
